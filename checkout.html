<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="img/favicon.ico">

    <title>ร้านหนังสือคำนำ - คำสั่งซื้อ</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/jquery.simple-dtpicker.css" rel="stylesheet">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/form-validation.css" rel="stylesheet">
    <link href="css/step-progress-bar.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/overlay.css" rel="stylesheet" />
  </head>

  <body class="bg-light">

    <div class="container">
      <!-- OrderID Search Box -->
      <div class="py-5 text-center" id="search-order" style="display:none">
        <div class="input-group">
          <div class="input-group-prepend">
            <span class="input-group-text">ID</span>
          </div>
          <input type="text" class="form-control" placeholder="กรอกเลขที่คำสั่งซื้อ" id="input-order-id">
          <a class="btn btn-color" role="button" onclick="searchOrderId()">ค้นหา</a>
        </div>
      </div>
      <!-- Progress of Checkout Process Step -->
      <div class="py-5 text-center" id="order-header">
        <p><img src="" width="200" id="img-1book"></p>
        <h2 id="order-id"></h2>
        <p class="lead">กรุณาบันทึกภาพหน้าจอ หรือบันทึกเลขที่คำสั่งซื้อนี้ไว้ เพื่อใช้อ้างอิงและตรวจสอบ</p>
      </div>
      <div class="row">
        <div class="card-body">
          <ul class="progressbar d-flex justify-content-center" id="process-step">
            <!-- Progressbar of process step will be here -->
          </ul>
        </div>
      </div>

      <hr id="shipping-address">

      <div class="row" id="order-content">

        <div class="col-md-4 order-md-2 mb-4">
          <!-- Cart -->
          <p>
            <h4 class="d-flex justify-content-between align-items-center mb-3">
              <span class="text-secondary"><i class="fa fa-shopping-cart"></i> ตะกร้าสินค้า</span>
              <span class="badge badge-secondary badge-pill" id="count-cart"></span>
            </h4>
          </p>
          <ul class="list-group mb-3" id="list-cart">
            <!-- Cart items will be here -->
          </ul>
          <!-- Self Picking -->
          <div id="modalSelfPick" class="modal fade" role="dialog">
            <div class="modal-dialog modal-sm">

              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="modal-self-pick">รับเองที่ "คำนำ"</h4>
                </div>
                <div class="modal-body">
                  <p>กรุณาระบุข้อมูลต่อไปนี้ให้ครบถ้วน</p>
                  <p>ชื่อผู้รับ <input type="text" class="form-control" name="self-pick-name" id="self-pick-name"></p>
                  <p>เบอร์โทร <input type="text" class="form-control" name="self-pick-phone" id="self-pick-phone"></p>
                  <p>อีเมล <input type="text" class="form-control" name="self-pick-email" id="self-pick-email"></p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-light" data-dismiss="modal" id="cancel-self-pick" onclick="onSubmitSelfPick('0')">ยกเลิก</button>
                  <button type="button" class="btn btn-default" data-dismiss="modal" id="confirm-self-pick" onclick="onSubmitSelfPick('1')">ยืนยันรับเอง</button>
                </div>
              </div>

            </div>
          </div>
          <!-- Payment -->
          <div id="payment-panel" style="display:none">
            <p id="payment-method"></p>
            <h4 class="mb-3"><span class="text-secondary"><i class="fa fa-money"></i> วิธีการชำระเงิน</span></h4>
            <h5 class="mb-3">1. โอนเงินด้วยวิธี <u>สแกนคิวอาร์โค้ด</u> </h5>
            <img class="mb-3" src="" alt="Promtpay QR Code" style="width:100%" id="bank-account-qr">
            <!--
            <p class="text-dark">สแกนคิวอาร์โค้ดเพื่อโอนเงิน หรือ
              โอนเงินเข้าบัญชี ชื่อ <span class="badge badge-primary" id="bank-account-owner"></span>
              เลขที่บัญชี <span class="badge badge-primary" id="bank-account-number"></span> <span class="badge badge-secondary" id="bank-account-name"></span>
              <br><img src="" id="bank-account-banner">
            </p>
            -->
            <hr>
            <p><h5 class="mb-3">2. แจ้งยืนยันการชำระเงิน</h5></p>
            <p class="text-dark">เมื่อชำระเงินแล้ว กรุณากดปุ่ม "แจ้งการชำระเงิน"
            <!--
            <form class="card p-2" id="form-payment">
              <div class="input-group">
                <input type="text" class="form-control" name="datepicker" id="datepicker">
                <div class="input-group-append">
                  <button type="submit" class="btn btn-success" data-toggle="modal" data-target="#modalTransfer"><big>แจ้งการชำระเงิน</big></button>
                </div>

                <div id="modalTransfer" class="modal fade" role="dialog">
                  <div class="modal-dialog modal-sm">

                    <div class="modal-content">
                      <div class="modal-header">
                        <h4 class="modal-title" id="modal-title"></h4>
                      </div>
                      <div class="modal-body">
                        <p>แจ้งการชำระเงินแล้ว กรุณารอผลการตรวจสอบ และยืนยันภายใน 24 ชม.</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">ตกลง</button>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </form> - end -->
            <p><a class="btn btn-primary btn-block" data-toggle="modal" data-target="#modalTransfer">แจ้งการชำระเงิน</a></p>

            <div id="modalTransfer" class="modal fade" role="dialog">
              <div class="modal-dialog modal-sm">

                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title" id="modal-title"></h4>
                  </div>
                  <div class="modal-body">
                    <h5>โปรดระบุวันเวลาที่ <u>ปรากฏบนสลิปการโอน</u></h5><span class="text-primary">(แตะที่ช่องเพื่อเปลี่ยนวันที่และเวลา)</span>
                    <input type="text" class="form-control" name="datepicker" id="datepicker">
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="onSubmitPayment()" >ยืนยันการโอน</button>
                  </div>
                </div>

              </div>
            </div>

            <div id="modalRequestSent" class="modal fade" role="dialog">
              <div class="modal-dialog modal-sm">

                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title" id="modal-request"></h4>
                  </div>
                  <div class="modal-body">
                    <p>ร้านหนังสือคำนำได้รับ "คำสั่งซื้อ" และ "การแจ้งชำระเงิน" ของท่านแล้ว กรุณารอผลการตรวจสอบยอดเงิน และยืนยันกลับภายใน 24 ชม. ทางอีเมลของท่าน</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">ตกลง</button>
                  </div>
                </div>

              </div>
            </div>

            <div id="payment-notification">
              <p class="text-muted" style="margin-top:5px;">
                <div id="notify-rejected" style="display:none">
                  <div class="alert alert-danger" role="alert"><i class="fa fa-exclamation-circle fa-lg"></i> แอดมินตรวจสอบแล้ว ไม่พบรายการโอนเงิน ตามวัน-เวลาที่ท่านแจ้งเอาไว้</div>
                  <mark>กรุณาตรวจสอบการโอนของท่าน</mark> และแจ้งวัน-เวลาที่ถูกต้องอีกครั้ง
                  หากต้องการติดต่อเจ้าหน้าที่ โทร.<span id="callcenter-no"></span>
                </div>
                <div id="notify-wait" style="display:none">
                  <div class="alert alert-success" role="alert"><i class="fa fa-check-circle fa-lg"></i> ร้านหนังสือคำนำได้รับ "คำสั่งซื้อ" และ "การแจ้งชำระเงิน" ของท่านแล้ว กรุณารอผลการตรวจสอบยอดเงิน และยืนยันกลับภายใน 24 ชม. ทางอีเมลของท่าน</div>
                </div>
              </p>
            </div>
          </div>
        </div>
        <!-- Shipping Address -->
        <div class="col-md-8 order-md-1">
          <p>
            <h4 class="d-flex justify-content-left align-items-center mb-3" id="header-shipping-address"></h4>
          </p>
          <form class="needs-validation" novalidate id="form-address">
            <fieldset id="entire-form" disabled>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="firstName">ชื่อผู้รับ</label>
                  <input type="text" class="form-control" id="firstName" placeholder="" value="" required>
                  <div class="invalid-feedback">
                    โปรดระบุชื่อผู้รับ
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="lastName" id="last-name-label">นามสกุลผู้รับ</label>
                  <input type="text" class="form-control" id="lastName" placeholder="" value="" required>
                  <div class="invalid-feedback">
                    โปรดระบุนามสกุลผู้รับ
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="username">เบอร์โทรผู้รับ</label>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text">โทร.</span>
                  </div>
                  <input type="text" class="form-control" id="username" placeholder="กรอกเฉพาะตัวเลข 10 หลัก" required>
                  <div class="invalid-feedback" style="width: 100%;">
                    โปรดระบุเบอร์โทรศัพท์ติดต่อผู้รับ
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="email">อีเมล</label>
                <input type="email" class="form-control" id="email" placeholder="you@example.com" required>
                <div class="invalid-feedback">
                  โปรดกรอกอีเมลเพื่อรับใบเสร็จอิเลคทรอนิคส์ เอาไว้ใช้อ้างอิงและตรวจสอบ
                </div>
              </div>

              <div id="group-address">

                <div class="mb-3">
                  <label for="address">ที่อยู่จัดส่ง</label>
                  <input type="text" class="form-control" id="address" placeholder="ที่อยู่ไปรษณีย์ (ไม่รวมจังหวัด)" required>
                  <div class="invalid-feedback">
                    โปรดระบุที่อยู่
                  </div>
                </div>
                <!-- Address2
                <div class="mb-3">
                  <label for="address2">Address 2 <span class="text-muted">(Optional)</span></label>
                  <input type="text" class="form-control" id="address2" placeholder="Apartment or suite">
                </div>
                -->
                <div class="row">
                  <div class="col-md-5 mb-3">
                    <label for="country">ประเทศ</label>
                    <select class="custom-select d-block w-100" id="country" required>
                      <option value="">เลือก...</option>
                      <option>ไทย</option>
                    </select>
                    <div class="invalid-feedback">
                      โปรดระบุประเทศ
                    </div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="state">จังหวัด</label>
                    <select class="custom-select d-block w-100" id="state" required>
                      <option value="">เลือก...</option>
                      <optgroup label="--- กทม.และปริมณฑล ---">
                        <option>กรุงเทพมหานคร </option>
                        <option>นนทบุรี </option>
                        <option>ปทุมธานี </option>
                        <option>สมุทรปราการ </option>
                        <option>สมุทรสาคร </option>
                      </optgroup>
                      <optgroup label="--- ภาคเหนือ ---">
                        <option>เชียงราย </option>
                        <option>เชียงใหม่ </option>
                        <option>น่าน </option>
                        <option>พะเยา </option>
                        <option>แพร่ </option>
                        <option>แม่ฮ่องสอน </option>
                        <option>ลำปาง </option>
                        <option>ลำพูน </option>
                        <option>อุตรดิตถ์</option>
                      </optgroup>
                      <optgroup label="--- ภาคอิสาน ---">
                        <option>กาฬสินธุ์ </option>
                        <option>ขอนแก่น </option>
                        <option>ชัยภูมิ </option>
                        <option>นครพนม </option>
                        <option>นครราชสีมา </option>
                        <option>บึงกาฬ </option>
                        <option>บุรีรัมย์ </option>
                        <option>มหาสารคาม </option>
                        <option>มุกดาหาร </option>
                        <option>ยโสธร </option>
                        <option>ร้อยเอ็ด </option>
                        <option>เลย </option>
                        <option>สกลนคร </option>
                        <option>สุรินทร์ </option>
                        <option>ศรีสะเกษ </option>
                        <option>หนองคาย </option>
                        <option>หนองบัวลำภู </option>
                        <option>อุดรธานี </option>
                        <option>อุบลราชธานี </option>
                        <option>อำนาจเจริญ  </option>
                      </optgroup>
                      <optgroup label="--- ภาคกลาง ---">
                        <option>กำแพงเพชร </option>
                        <option>ชัยนาท </option>
                        <option>นครนายก </option>
                        <option>นครปฐม </option>
                        <option>นครสวรรค์ </option>
                        <option>พระนครศรีอยุธยา </option>
                        <option>พิจิตร </option>
                        <option>พิษณุโลก </option>
                        <option>เพชรบูรณ์ </option>
                        <option>ลพบุรี </option>
                        <option>สมุทรสงคราม </option>
                        <option>สิงห์บุรี </option>
                        <option>สุโขทัย </option>
                        <option>สุพรรณบุรี </option>
                        <option>สระบุรี </option>
                        <option>อ่างทอง </option>
                        <option>อุทัยธานี </option>
                      </optgroup>
                      <optgroup label="--- ภาคตะวันออก ---">
                        <option>จันทบุรี </option>
                        <option>ฉะเชิงเทรา </option>
                        <option>ชลบุรี </option>
                        <option>ตราด </option>
                        <option>ปราจีนบุรี </option>
                        <option>ระยอง </option>
                        <option>สระแก้ว</option>
                      </optgroup>
                      <optgroup label="--- ภาคตะวันตก ---">
                        <option>กาญจนบุรี </option>
                        <option>ตาก </option>
                        <option>ประจวบคีรีขันธ์ </option>
                        <option>เพชรบุรี </option>
                        <option>ราชบุรี </option>
                      </optgroup>
                      <optgroup label="--- ภาคใต้ ---">
                        <option>กระบี่ </option>
                        <option>ชุมพร </option>
                        <option>ตรัง </option>
                        <option>นครศรีธรรมราช </option>
                        <option>นราธิวาส </option>
                        <option>ปัตตานี </option>
                        <option>พังงา </option>
                        <option>พัทลุง </option>
                        <option>ภูเก็ต </option>
                        <option>ระนอง </option>
                        <option>สตูล </option>
                        <option>สงขลา </option>
                        <option>สุราษฎร์ธานี </option>
                        <option>ยะลา</option>
                      </optgroup>
                    </select>
                    <div class="invalid-feedback">
                      โปรดระบุจังหวัด
                    </div>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="zip">รหัสไปรษณีย์</label>
                    <input type="text" class="form-control" id="zip" placeholder="" required>
                    <div class="invalid-feedback">
                      โปรดระบุรหัสไปรษณีย์
                    </div>
                  </div>
                </div>
              </div> <!-- End of 'group-address' -->

              <hr class="mb-4">
              <button class="btn btn-primary btn-lg btn-block" type="submit" id="submit-address"><big><big>บันทึกข้อมูลผู้รับ</big></big></button>
          </fieldset>
          </form>
        </div>
      </div>

      <footer class="my-5 pt-5 text-muted text-center text-small">
        <p class="mb-1">&copy; 2021 "คำนำ"</p>
        <ul class="list-inline">
          <li class="list-inline-item"><a href="index.html"><i class="fa fa-home"></i> หน้าแรก</a></li>
          <li class="list-inline-item"><a id="shop-link" target="_blank"><i class="fa fa-book"></i> หน้าร้าน</a></li>
          <!-- <li class="list-inline-item"><a href="#">Terms</a></li> -->
          <!-- <li class="list-inline-item"><a href="#">Support</a></li> -->
        </ul>
      </footer>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')</script>
    <script src="js/popper.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="js/holder.min.js"></script>
    <script src="js/moment.js"></script>
    <script src="js/jquery.simple-dtpicker.js"></script>

    <!-- KumNum Store JavaScript -->
    <script type="text/javascript" src="js/manutils.js"></script>

    <script>
      // Example starter JavaScript for disabling form submissions if there are invalid fields
      (function() {
        'use strict';

        window.addEventListener('load', function() {
          // Fetch all the forms we want to apply custom Bootstrap validation styles to
          var forms = document.getElementsByClassName('needs-validation');

          // Loop over them and prevent submission
          var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
              if (form.checkValidity() === false) {
                event.preventDefault();
                event.stopPropagation();
              }
              form.classList.add('was-validated');
            }, false);
          });
        }, false);
      })();
    </script>

    <!-- Checkout JavaScript -->
    <script type="text/javascript">
      //const sheetURL = 'https://sheet.best/api/sheets/b195e9e6-e211-451d-8054-53bf717c89e6'; // Production (pnakapat)
      const sheetURL = 'https://sheet.best/api/sheets/5acb1568-5ff2-4717-81dc-23a4093f6cbc'; // Production (nakapatp)
      //const sheetURL = 'https://sheet.best/api/sheets/86299b5c-1850-4f51-b969-a44721bfe390'; // Dev
      var globalVars = null;
      var dataOrder = null;
      var dataSales = null;
      var dataProduct = null; //1Book Checkout
      var shopId = null;

      $(function(){
        $('*[name=datepicker]').appendDtpicker({
          "closeOnSelected":true,
        });
      });

      function getTrackingLink(Transporter) {
        var url = "";
        switch (Transporter) {
          case 'Flash': url = manUtils.getGlobalVars('trackingFlash'); break;
          case 'J&T': url = manUtils.getGlobalVars('trackingJ&T'); break;
          case 'Kerry': url = manUtils.getGlobalVars('trackingKerry'); break;
          case 'NimExpress': url = manUtils.getGlobalVars('trackingNimExpress'); break;
          case 'ThaiPost': url = manUtils.getGlobalVars('trackingThaiPost'); break;
          default: url = "#"
        }
        return url;
      }

      function mailTo(obj, tab) {
        //var mailSheet = 'https://sheet.best/api/sheets/20a4b95a-0187-4695-bfa9-360399f7ed21'; // (pnakapat)
        var mailSheet = 'https://sheet.best/api/sheets/75d801e4-e156-4fd3-995f-7fd2865799a0'; // (nakapatp)

        fetch(mailSheet + '/tabs/' + tab, {
          method: "POST",
          mode: "cors",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(obj),
        })
        .then((response) => { return response.json(); })
        .then((data) => {})
        .catch((error) => { console.log(error); });
      }

      function showCartItem(data) {
        var sum = 0;
        var html = "";
        for (var i in data) {
          sum += Number(data[i].Amount);

          html += '<li class="list-group-item d-flex justify-content-between lh-condensed">';
            html += '<div>';
              html += '<h6 class="my-0">' + data[i].Title.slice(0,18) + '... (' + data[i].Amount + ' เล่ม)</h6>';
              html += '<small class="text-muted">' + data[i].Author + '</small>';
            html += '</div>';
            html += '<span class="text-muted">' + data[i].SubTotal + '</span>';
          html += '</li>';
        }
        // SubTotal
        html += '<li class="list-group-item d-flex justify-content-between lh-condensed">';
          html += '<div>';
            html += '<h6 class="my-0">รวม</h6>';
          html += '</div>';
          html += '<span class="text-muted">' + manUtils.formatNumber(dataOrder.SubTotal, 2) + '</span>';
        html += '</li>';
        // ShippingCost
        html += '<li class="list-group-item d-flex justify-content-between bg-light">';
          html += '<div class="text-success">';
            html += '<h6 class="my-0">ค่าจัดส่ง</h6>';
          html += '</div>';
          html += '<span class="text-success">' + manUtils.formatNumber(dataOrder.SelfPick == "1" ? 0 : dataOrder.ShippingCost, 2) + '</span>';
        html += '</li>';
        // Total
        html += '<li class="list-group-item list-group-item-secondary d-flex justify-content-between">';
        html += '<h3><strong>ยอดโอน</strong></h3>';
        html += '<h3><strong>' + manUtils.formatNumber(dataOrder.GrandTotal - (dataOrder.SelfPick == "1" ? dataOrder.ShippingCost : 0), 2) + ' </strong></h3>';
        html += '</li>';

        //console.log(html);
        var cart = document.getElementById('list-cart');
        cart.innerHTML = html;

        // Number of items in cart
        var count = document.getElementById('count-cart');
        count.innerHTML = sum;
      }
      function showOrderInfo() {
        // OrderId
        var hOrderId = document.getElementById('order-id');
        if (hOrderId) hOrderId.innerHTML = "คำสั่งซื้อเลขที่ " + dataOrder.OrderId;
        var modalTitle = document.getElementById('modal-title');
        if (modalTitle) modalTitle.innerHTML = "คำสั่งซื้อเลขที่ " + dataOrder.OrderId;
        var modalRequest = document.getElementById('modal-request');
        if (modalRequest) modalRequest.innerHTML = "คำสั่งซื้อเลขที่ " + dataOrder.OrderId;

        var shopLink = document.getElementById('shop-link');
        shopLink.href = (shopId)
                      ? manUtils.getGlobalVars('shopURL') + '?id=' + shopId
                      : manUtils.getGlobalVars('shopURL');

        if (dataProduct) {
          document.getElementById('img-1book').src = dataProduct.ImageFull;
        }

        // Checkout Process Step
        var progress = document.getElementById('process-step');
        var html = "";

        // STEP 1 -- Place order
        html += '<li class="active">';
          html += '<div class="text-success" style="margin-top:10px;">สร้างคำสั่งซื้อ</div>';
          html += '<div class="text-muted"><small>เมื่อวันที่ '+ dataOrder.CreatedDate + " " + dataOrder.CreatedTime.slice(0,5) + ' น.</small></div>';
        html += '</li>';
        // STEP 2 -- Shipping Address
        if (dataOrder.OrderStatus == 'ป้อนข้อมูลจัดส่ง') {
          html += '<li>';
          html += '<div class="text-primary" style="margin-top:10px;">ป้อนข้อมูลจัดส่ง</div>';
          //html += '<div style="margin-top:10px;"><a href="#shipping-address" class="btn btn-outline-primary active" role="button">ป้อนข้อมูลจัดส่ง</a></div>';
          html += '<div style="margin-top:10px;"><a href="#payment-method" class="btn btn-primary btn-sm" role="button" data-toggle="modal" data-target="#modalSelfPick"><big>รับเองที่ "คำนำ"</big></a></div>';
          html += '<div class="text-muted"><small>กรณีมารับเอง ไม่เสียค่าจัดส่ง</small></div>';
        } else {
          html += '<li class="active">'
          if (dataOrder.SelfPick == "1")
            html += '<div style="margin-top:6px;"><big><span class="badge badge-warning badge-pill" id="badge-self-pick">รับเองที่ "คำนำ"</span></big></div>';
          else html += '<div class="text-success" style="margin-top:10px;">ป้อนข้อมูลจัดส่ง</div>';
          if (dataOrder.OrderStatus == 'รอการชำระเงิน'
              || dataOrder.OrderStatus == 'ชำระเงินแล้วรอตรวจสอบ') {

            html += '<div class="text-muted"><small>';
              html += 'สามารถเปลี่ยนแปลงข้อมูลได้ จนถึงก่อนการชำระเงินเสร็จสมบูรณ์';
              //html += '<a href="tracking.html?id=' + dataOrder.OrderId + '&act=edit" class="btn btn-outline-secondary btn-sm" role="button">แก้ไข</a>';
            html += '</small></div>';
            html += '<div style="margin-top:10px;"><a href="#payment-method" class="btn ' + (dataOrder.SelfPick == "1" ? 'btn-dark' : 'btn-primary') + ' btn-sm" role="button" data-toggle="modal" data-target="#modalSelfPick"><big>' + (dataOrder.SelfPick == "1" ? 'เปลี่ยนแปลง' : 'รับเองที่ "คำนำ"') + '</big></a></div>';
            //html += '<div class="text-muted"><small>กรณีรับเอง ไม่เสียค่าจัดส่ง</small></div>';
          } else {
            html += '<div class="text-muted"><small>ยืนยันโดยผู้ซื้อแล้ว</small></div>';
          }
        }
        html += '</li>';
        // STEP 3 -- Make Payment
        if (dataOrder.OrderStatus == 'ป้อนข้อมูลจัดส่ง') {
          html += '<li>';
          html += '<div style="margin-top:10px; color:#cccccc">รอการชำระเงิน</div>';

        } else if (dataOrder.OrderStatus == 'รอการชำระเงิน'
            || dataOrder.OrderStatus == 'ชำระเงินแล้วรอตรวจสอบ') {

          if (dataOrder.OrderStatus == 'รอการชำระเงิน') {
            html += '<li>';
            html += '<div class="text-success" style="margin-top:10px;">รอการชำระเงิน</div>';
            html += '<div class="text-muted"><small>ชำระเงินแล้วกรุณาแจ้งวัน-เวลาโอน</small></div>';
            html += '<div style="margin-top:10px;"><a href="#payment-method" class="btn btn-primary btn-sm" role="button"><big>วิธีชำระเงิน</big></a></div>';
          } else if (dataOrder.OrderStatus == 'ชำระเงินแล้วรอตรวจสอบ') {
            html += '<li>';
            html += '<div class="text-success" style="margin-top:10px;">ชำระเงินแล้วรอตรวจสอบ</div>';
            html += '<div class="text-muted"><small>เมื่อวันที่ '+ dataOrder.PaymentDate + " " + dataOrder.PaymentTime.slice(0,5) + ' น.</small></div>';
            if (Number(dataOrder.VerifyRejected) == 1) {
              html += '<div class="text-danger"><small>ตรวจสอบแล้วไม่พบรายการตามที่แจ้งไว้</small></div>';
              html += '<div style="margin-top:10px;"><a href="#payment-method" class="btn btn-primary btn-sm" role="button"><big>วิธีชำระเงิน</big></a></div>';
            }
            else html += '<div class="text-muted"><small>กรุณารอการยืนยันยอดชำระใน 24 ชม.</small></div>';
          }
        } else {
          html += '<li class="active">';
          html += '<div class="text-success" style="margin-top:10px;">ชำระเงินเสร็จสมบูรณ์</div>';
          html += '<div class="text-muted"><small>เมื่อวันที่ '+ dataOrder.PaymentDate + " " + dataOrder.PaymentTime.slice(0,5) + ' น.</small></div>';
          html += '<div style="margin-top:5px;"><a href="' + manUtils.getGlobalVars('invoiceURL') + '?id=' + dataOrder.OrderId + '" class="btn btn-secondary btn-sm" role="button" target="_blank">พิมพ์ใบเสร็จ</a></div>';
        }
        html += '</li>';
        // STEP 4 -- Packaging & Delivery
        if (dataOrder.OrderStatus == 'ชำระเงินเสร็จสมบูรณ์') {
          html += '<li class="active">';
          if (dataOrder.TrackingCode == null
              || dataOrder.TrackingCode == "") {
            html += '<div class="text-primary" style="margin-top:10px;">ผลิตและจัดส่งพัสดุ</div>';
            html += '<div class="text-muted"><small>' + (dataOrder.SelfPick == "1" ? 'สามารถรับหนังสือได้ภายใน 3-7 วัน' : 'พัสดุจะเริ่มออกเดินทางภายใน 3-7 วัน') + '</small></div>';
          } else {
            html += '<div class="text-success" style="margin-top:10px;">จัดส่งพัสดุแล้ว</div>';
            html += '<div class="text-muted"><small>';
              html += 'เลขติดตามพัสดุ ' + dataOrder.TrackingCode;
              html += '<div style="margin-top:5px;"><a href="' + getTrackingLink(dataOrder.Transporter) +'" class="btn btn-secondary btn-sm" role="button" target="_blank">ติดตามพัสดุ</a></div>';
            html += '</small></div>';
          }
        } else {
          html += '<li>';
          html += '<div style="margin-top:10px; color:#cccccc">ผลิตและจัดส่งพัสดุ</div>';
        }
        html += '</li>';

        progress.innerHTML = html;
      }

      function showPaymentNotification() {
        document.getElementById('bank-account-qr').src = manUtils.getGlobalVars('bankAccountQR');
        //document.getElementById('bank-account-banner').src = manUtils.getGlobalVars('bankAccountBanner');
        /*
        document.getElementById('bank-account-owner').innerHTML = manUtils.getGlobalVars('bankAccountOwner');
        document.getElementById('bank-account-number').innerHTML = manUtils.getGlobalVars('bankAccountNumber');
        document.getElementById('bank-account-name').innerHTML = manUtils.getGlobalVars('bankAccountName');
        */
        document.getElementById('callcenter-no').innerHTML = manUtils.getGlobalVars('callcenterNumber');

        var formSubmit = document.getElementById('form-payment');
        if (formSubmit) formSubmit.setAttribute('action', "checkout.html?id=" + dataOrder.OrderId)

        var form = document.getElementById('payment-panel');

        if (dataOrder.OrderStatus == 'ป้อนข้อมูลจัดส่ง'
            || dataOrder.OrderStatus == 'ชำระเงินเสร็จสมบูรณ์') {

          form.style.display = 'none';

        } else {

          form.style.display = 'block';

          var picker = document.getElementById('datepicker');

          if (dataOrder.PaymentDate && dataOrder.PaymentTime)
            picker.value = dataOrder.PaymentDate + ' ' + dataOrder.PaymentTime.slice(0,5);

          var wait = document.getElementById('notify-wait');
          var rejected = document.getElementById('notify-rejected');

          if (dataOrder.OrderStatus == 'ชำระเงินแล้วรอตรวจสอบ') {
            wait.style.display = (Number(dataOrder.VerifyRejected) == 0) ? 'block' : 'none';
            rejected.style.display = (Number(dataOrder.VerifyRejected) == 1) ? 'block' : 'none';
          }
        }
      }

      function searchOrderId() {
        window.location.href = "checkout.html?id=" + document.getElementById('input-order-id').value;
      }

      function showShippingAddress() {
        var header = document.getElementById('header-shipping-address');
        header.innerHTML = "ข้อมูลสำหรับจัดส่งหนังสือ";
        if (dataOrder.SelfPick == "1") {
          header.innerHTML += '&nbsp;&nbsp;<span class="badge badge-warning badge-pill" id="badge-self-pick">รับเองที่ "คำนำ"</span>';
        }
        document.getElementById('self-pick-name').value = dataOrder.FirstName;
        document.getElementById('self-pick-phone').value = dataOrder.Phone;
        document.getElementById('self-pick-email').value = dataOrder.Email;

        var form = document.getElementById('form-address');
        form.setAttribute('action', "checkout.html?id=" + dataOrder.OrderId);

        var inFirstName = document.getElementById('firstName');
        var inLastName = document.getElementById('lastName');
        var inUsername = document.getElementById('username');
        var inEmail = document.getElementById('email');
        var inAddress = document.getElementById('address');
        var inCountry = document.getElementById('country');
        var inState = document.getElementById('state');
        var inZip = document.getElementById('zip');
        //var btnSubmit = document.getElementById('submit-address');

        inFirstName.value = dataOrder.FirstName;
        inLastName.value = dataOrder.LastName;
        inUsername.value = dataOrder.Phone;
        inEmail.value = dataOrder.Email;
        inAddress.value = dataOrder.Address;
        manUtils.selectElement('country', dataOrder.Country);
        manUtils.selectElement('state', dataOrder.Province);
        inZip.value = dataOrder.Zip;

        var fieldset = document.getElementById('entire-form');

        if (dataOrder.OrderStatus == 'ชำระเงินเสร็จสมบูรณ์') {
          fieldset.disabled = true;
        } else {
          fieldset.disabled = false;
        }

        document.getElementById('group-address').style.display = (dataOrder.SelfPick == "1") ? "none" : "block";
        document.getElementById('last-name-label').style.display = (dataOrder.SelfPick == "1") ? "none" : "block";
        inLastName.style.display = (dataOrder.SelfPick == "1") ? "none" : "block";
      }
      function generateOrderId(contactId) {
        var orderId = Math.floor(100000 + Math.random() * 900000);
        return contactId + manUtils.generateRandomLetter() + orderId;
      }
      function getCartWeight(amount, weight) {
        var sumWeight = amount * weight;
        return (sumWeight < 1) ? 1 : sumWeight;
      }
      function getShippingCostByWeight(asNumber, weight, amount) {
        var html = "";
        var cost = 0;
        var expected = (amount > 0)
                     ? Number(manUtils.getGlobalVars('costFlat')) + (Math.ceil(weight) * Number(manUtils.getGlobalVars('costStep')))
                     : 0;

        cost = (amount >= Number(manUtils.getGlobalVars('costFreeBar')))
             ? 0
             : expected;

        if (cost == 0) {
          return (asNumber) ? 0 : (expected > 0) ? '<del class="text-muted">' + manUtils.formatNumber(expected, 2) + '</del>' : manUtils.formatNumber(expected, 2);
        } else {
          return (asNumber) ? cost : manUtils.formatNumber(cost, 2);
        }
      }
      function onCreateOrder(amount) {
        // Create new order
        var subTotal = amount * dataProduct.Price;
        var orderId = generateOrderId(dataProduct.ContactId);
        var d = new Date();
        var currentDate = d.toISOString().slice(0, 10);
        var currentTime = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(11,16);
        var sumWeight = getCartWeight(amount, dataProduct.Weight);
        var grand = (amount >= manUtils.getGlobalVars('costFreeBar'))
                  ? String(subTotal)
                  : String(Number(subTotal) + getShippingCostByWeight(true, sumWeight, amount));

        const data = {
          OrderId: orderId,
          OrderStatus: 'ป้อนข้อมูลจัดส่ง',
          Count: String(amount),
          SubTotal: String(subTotal),
          ShippingCost: String(getShippingCostByWeight(true, sumWeight, amount)),
          GrandTotal: grand,
          PaymentVerified: "0",
          VerifyRejected: "0",
          Transporter: "อื่น ๆ",
          Notified: "0",
          TotalWeight: sumWeight,
          Printed: "0",
          SelfPick: "0",
          CreatedDate: currentDate,
          CreatedTime: currentTime,
        };

        // Create new sale record
        var arrSales = new Array();
        const sales = {
          OrderId: orderId,
          ProductId: dataProduct.ProductId,
          Title: dataProduct.Title,
          ContactId: dataProduct.ContactId,
          Author: dataProduct.Author,
          Amount: String(amount),
          Price: String(dataProduct.Price),
          SubTotal: String(subTotal),
          PaymentStatus: "รอการชำระเงิน",
          SharePerUnit: dataProduct.SharePerUnit,
          PublisherShare: amount * dataProduct.PublisherShare,
          CopyrightShare: amount * dataProduct.SharePerUnit,
          PlatformShare: amount * dataProduct.PlatformShare,
          ProductionCost: amount * dataProduct.Cost,
        };
        arrSales.push(sales);

        fetch(sheetURL + '/tabs/Orders', {
          method: "POST",
          mode: "cors",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
        .then((response) => { return response.json(); })
        .then((myJson) => {
          dataOrder = myJson[0];

          // POST new Sales records.
          fetch(sheetURL + '/tabs/Sales', {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(arrSales),
          })
          .then((response) => response.json())
          .then((myJson) => {
            dataSales = myJson;
            //console.log("New sales are recorded.")
            //console.log(data);
            shopId = dataProduct.ContactId;

            showOrderInfo();
            showShippingAddress();
            showCartItem(dataSales);
            showPaymentNotification();

            document.getElementById('overlay').style.display = "none";
          })
          .catch((error) => {
            console.log(error);
            // Show 'Search Box'
            document.getElementById('search-order').style.display = 'block';
            document.getElementById('order-header').style.display = 'none';
            document.getElementById('order-content').style.display = 'none';
          });
        })
        .catch((error) => {
          console.log(error);
          // Show 'Search Box'
          document.getElementById('search-order').style.display = 'block';
          document.getElementById('order-header').style.display = 'none';
          document.getElementById('order-content').style.display = 'none';
        });
      }

      function onLoadProduct(productId, amount) {
        var div = document.createElement("div");
        div.className += "overlay";
        div.id = "overlay";
        document.body.appendChild(div);

        fetch(sheetURL + '/tabs/Products/ProductId/*' + productId + '*')
        .then((response) => { return response.json(); })
        .then((myJson) => {
          //console.log(myJson);
          dataProduct = myJson[0];
          onCreateOrder(amount); // Automatically create order
        })
        .catch((error) => {
          console.log(error);
          // Show 'Search Box'
          document.getElementById('search-order').style.display = 'block';
          document.getElementById('order-header').style.display = 'none';
          document.getElementById('order-content').style.display = 'none';
        });
      }

      function onSubmitPayment() {
        var picker = document.getElementById('datepicker');

        if (picker.value) {
          //e.preventDefault();

          dataOrder.PaymentDate = picker.value.slice(0,10);
          dataOrder.PaymentTime = picker.value.slice(11,16);
          dataOrder.PaymentVerified = "0";
          dataOrder.VerifyRejected = "0";
          dataOrder.OrderStatus = "ชำระเงินแล้วรอตรวจสอบ";

          fetch(sheetURL + '/tabs/Orders/OrderId/*' + dataOrder.OrderId + '*',
            {
              method: "PATCH",
              mode: "cors",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(dataOrder),
            }
          )
          .then((response) => { return response.json(); })
          .then((data) => {
            showOrderInfo();
            showPaymentNotification();
            //window.location.href = manUtils.getGlobalVars('checkoutURL') + '?id=' + dataOrder.OrderId;
            var row = dataOrder;
            var mail = {
              Code: 'SubmitPayment',
              OrderId: row.OrderId,
              Name: row.FirstName + ' ' + row.LastName,
              Phone: manUtils.formatPhoneNumber(row.Phone),
              Email: row.Email,
              Address: row.Address,
              Province: row.Province,
              Zip: row.Zip,
              PaidAmount: (row.SelfPick == "1" ? row.GrandTotal - row.ShippingCost : row.GrandTotal),
              PaidDate: row.PaymentDate,
              PaidTime: row.PaymentTime,
              CreatedDate: manUtils.getCurrentDate(),
              CreatedTime: manUtils.getCurrentTime(),
            };
            mailTo(mail, 'SubmitPayment'); // Previous: 'Orders'

            $("#modalRequestSent").modal();
          })
          .catch((error) => { console.log(error); });
        }
      }

      function onSubmitSelfPick(strVal) {
        // Promtly RETURN if there is nothing change.
        if (strVal == dataOrder.SelfPick)
          return;

        var inSelfPickName = document.getElementById('self-pick-name');
        var inSelfPickPhone = document.getElementById('self-pick-phone');
        var inSelfPickEmail = document.getElementById('self-pick-email');

        //if (strVal == "1"
        //    && (inSelfPickName.Value == "" || inSelfPickPhone.Value))
        //  return;

        // Go on if changing is requested.
        var div= document.createElement("div");
        div.className += "overlay";
        document.body.appendChild(div);

        if (strVal == "1") {
          dataOrder.OrderStatus = "รอการชำระเงิน";
        } else {
          dataOrder.OrderStatus = "ป้อนข้อมูลจัดส่ง";
        }
        dataOrder.PaymentDate = "";
        dataOrder.PaymentTime = "";

        dataOrder.SelfPick = strVal;
        if (inSelfPickName.value)
          dataOrder.FirstName = document.getElementById('self-pick-name').value;
        if (inSelfPickPhone.value)
          dataOrder.Phone = document.getElementById('self-pick-phone').value;
        if (inSelfPickEmail.value)
          dataOrder.Email = document.getElementById('self-pick-email').value;

        fetch(sheetURL + '/tabs/Orders/OrderId/*' + dataOrder.OrderId + '*',
          {
            method: "PATCH",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(dataOrder),
          }
        )
        .then((response) => { return response.json(); })
        .then((data) => {
          //console.log("Success PATCH");
          window.location.href = 'checkout.html?id=' + dataOrder.OrderId;
        })
        .catch((error) => { console.log(error); });
      }

      $('#form-address').on('submit',function(e) {

        var form = document.getElementById('form-address');

        var inFirstName = document.getElementById('firstName');
        var inLastName = document.getElementById('lastName');
        var inUsername = document.getElementById('username');
        var inEmail = document.getElementById('email');
        var inAddress = document.getElementById('address');
        var inCountry = document.getElementById('country');
        var inState = document.getElementById('state');
        var inZip = document.getElementById('zip');

        if ((manUtils.hasClass(form, 'was-validated')
            && inFirstName.value && inLastName.value && inUsername.value && inEmail.value && inAddress.value && inCountry.value && inState.value && inZip.value)
            || (inFirstName.value && inLastName.value && inUsername.value && inEmail.value && inAddress.value && inCountry.value && inState.value && inZip.value)) {

          e.preventDefault();

          dataOrder.FirstName = inFirstName.value;
          dataOrder.LastName = inLastName.value;
          dataOrder.Phone = inUsername.value;
          dataOrder.Email = inEmail.value;
          dataOrder.Address = inAddress.value;
          dataOrder.Country = inCountry.value;
          dataOrder.Province = inState.value;
          dataOrder.Zip = inZip.value;
          dataOrder.OrderStatus = (dataOrder.OrderStatus == 'ป้อนข้อมูลจัดส่ง') ? 'รอการชำระเงิน' : dataOrder.OrderStatus;

          fetch(sheetURL + '/tabs/Orders/OrderId/*' + dataOrder.OrderId + '*',
            {
              method: "PATCH",
              mode: "cors",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(dataOrder),
            }
          )
          .then((response) => { return response.json(); })
          .then((data) => {
            //console.log("Success PATCH");
            //window.location.href = 'checkout.html?id=' + dataOrder.OrderId;
            showOrderInfo();
            showPaymentNotification();
            scroll(0,0);
          })
          .catch((error) => { console.log(error); });
        }
        else { console.log("Invalid form.");}
      })

      $('#form-payment').on('submit',function(e) {

      })
      function fetchSales(orderId) {
        // Get 'Sales' data
        fetch(sheetURL + '/tabs/Sales/OrderId/*' + orderId + '*')
        .then((response) => { return response.json(); })
        .then((myJson) => {
          dataSales = myJson;

          shopId = dataSales[0].ContactId;

          showOrderInfo();
          showShippingAddress();
          showCartItem(dataSales);
          showPaymentNotification();
        })
        .catch((error) => { console.log(error); });
      }

      window.addEventListener('load', (event) => {
        // GET GlobalVars
        // -- GET 'Order' data
        // ---- Get 'Sales' data
        fetch(sheetURL + '/tabs/GlobalVars')
        .then((response) => { return response.json(); })
        .then((myJson) => {
          globalVars = myJson;

          var orderId = manUtils.getParam('id');
          var productId = manUtils.getParam('product_id');

          /*
          if (orderId == null || orderId == "" || orderId == undefined) {
            document.getElementById('search-order').style.display = 'block';
            document.getElementById('order-header').style.display = 'none';
            document.getElementById('order-content').style.display = 'none';
          }
          */

          // Get 'Order' data
          fetch(sheetURL + '/tabs/Orders/OrderId/*' + orderId + '*')
          .then((response) => { return response.json(); })
          .then((myJson) => {
            dataOrder = myJson[0];

            if (dataOrder && dataOrder.OrderId == manUtils.getParam('id')) {
              fetchSales(orderId);
            } else if (productId) {
              onLoadProduct(productId, 1); // 1 unit of item (Default)
            } else {
              //console.log(dataOrder);
              document.getElementById('search-order').style.display = 'block';
              document.getElementById('order-header').style.display = 'none';
              document.getElementById('order-content').style.display = 'none';
            }
          })
          .catch((error) => { console.log(error); });
        })
        .catch((error) => { console.log(error); });
      });
    </script>
  </body>
</html>
